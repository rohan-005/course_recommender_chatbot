<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Recommendation Chatbot</title>
    <style>
        /* CSS Reset & Base Styles */
        :root {
            --bg-dark: #121212;
            --bg-darker: #0a0a0a;
            --bg-darkest: #050505;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-purple: #bb86fc;
            --accent-purple-light: #d1a4ff;
            --accent-cyan: #03dac6;
            --accent-cyan-light: #70efde;
            --accent-green: #39ff14;
            --accent-green-light: #76ff7a;
            --bubble-user: #2a2a2a;
            --bubble-bot: #1e1e1e;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 12px;
            --border-radius-small: 8px;
            --gradient-purple: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            --gradient-green: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
        }

        [data-theme="light"] {
            --bg-dark: #f5f5f5;
            --bg-darker: #e0e0e0;
            --bg-darkest: #d0d0d0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --bubble-user: #ffffff;
            --bubble-bot: #eeeeee;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            overflow-x: hidden;
            position: relative;
            line-height: 1.6;
            padding-top: 70px; /* Space for fixed navbar */
        }

        /* Background Shapes Animation */
        .shape {
            position: absolute;
            opacity: 0.08;
            z-index: -1;
            animation: float 15s infinite ease-in-out;
            filter: blur(1px);
        }

        .shape.circle {
            border-radius: 50%;
            background: var(--gradient-purple);
        }

        .shape.triangle {
            width: 0;
            height: 0;
            border-left: 25px solid transparent;
            border-right: 25px solid transparent;
            border-bottom: 50px solid var(--accent-purple);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }

        .shape.square {
            background: var(--gradient-green);
            transform: rotate(15deg);
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) rotate(5deg);
            }
        }

        /* Header Styles - Now Static */
        header {
            padding: 1rem 1.5rem;
            background-color: var(--bg-darker);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 70px;
        }

        [data-theme="light"] header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            font-weight: 700;
            font-size: 1.3rem;
            background: var(--gradient-purple);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 0.5px;
        }

        .logo::before {
            content: "✦";
            color: var(--accent-cyan);
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .header-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            padding: 0.5rem 0.75rem;
            border-radius: var(--border-radius-small);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .header-button .icon {
            font-size: 1.1rem;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(30deg) scale(1.1);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 1.5rem;
            overflow: hidden;
            position: relative;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            scroll-behavior: smooth;
        }

        /* Custom Scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-darker);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--accent-purple);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--accent-purple-light);
        }

        /* Message Bubbles */
        .message {
            max-width: 85%;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            line-height: 1.6;
            animation: fadeIn 0.4s ease;
            position: relative;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background-color: var(--bubble-bot);
            align-self: flex-start;
            border-bottom-left-radius: 0.2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] .bot-message {
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .user-message {
            background-color: var(--bubble-user);
            align-self: flex-end;
            border-bottom-right-radius: 0.2rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] .user-message {
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .bot-message::before {
            content: "";
            position: absolute;
            left: -8px;
            bottom: 0;
            width: 0;
            height: 0;
            border-right: 10px solid var(--bubble-bot);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .user-message::after {
            content: "";
            position: absolute;
            right: -8px;
            bottom: 0;
            width: 0;
            height: 0;
            border-left: 10px solid var(--bubble-user);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
        }

        .message-time {
            display: block;
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.5rem;
            text-align: right;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-self: flex-start;
            padding: 1rem 1.5rem;
            background-color: var(--bubble-bot);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            align-items: center;
            gap: 0.5rem;
        }

        .typing-indicator.active {
            opacity: 1;
        }

        .typing-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 60%, 100% {
                transform: translateY(0);
                background-color: var(--text-secondary);
            }
            30% {
                transform: translateY(-5px);
                background-color: var(--accent-purple);
            }
        }

        /* Input Area */
        .input-area {
            display: flex;
            gap: 0.75rem;
            padding: 1.25rem 0;
            position: relative;
            background-color: var(--bg-dark);
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--bg-darker);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 50px;
            max-height: 150px;
            resize: none;
        }

        [data-theme="light"] .chat-input {
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chat-input:focus {
            box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.3);
            border-color: var(--accent-purple);
        }

        .send-button {
            background: var(--gradient-purple);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            font-size: 1.2rem;
        }

        .send-button:hover {
            background: linear-gradient(135deg, var(--accent-purple-light), var(--accent-cyan-light));
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .send-button:disabled {
            background: var(--bg-darker);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow);
        }

        /* Quick Reply Buttons */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .quick-reply {
            background-color: var(--bg-darker);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            box-shadow: var(--shadow);
        }

        [data-theme="light"] .quick-reply {
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .quick-reply:hover {
            background-color: var(--accent-purple);
            color: var(--bg-darkest);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
            border-color: transparent;
        }

        /* Course Cards */
        .courses-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
        }

        .course-card {
            background-color: var(--bg-darker);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: var(--transition);
            cursor: pointer;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
        }

        [data-theme="light"] .course-card {
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .course-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-purple);
            box-shadow: var(--shadow-hover);
        }

        .course-card h3 {
            color: var(--accent-cyan);
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
            font-weight: 600;
            line-height: 1.4;
        }

        .course-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            flex-grow: 1;
        }

        .course-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-top: 1rem;
            align-items: center;
        }

        .course-category {
            background-color: rgba(3, 218, 198, 0.1);
            color: var(--accent-cyan);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .course-level {
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .course-level.beginner {
            background-color: rgba(3, 218, 198, 0.15);
            color: var(--accent-cyan);
        }

        .course-level.intermediate {
            background-color: rgba(187, 134, 252, 0.15);
            color: var(--accent-purple);
        }

        .course-level.advanced {
            background-color: rgba(57, 255, 20, 0.15);
            color: var(--accent-green);
        }

        .course-duration {
            color: var(--text-secondary);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .course-link {
            display: inline-flex;
            margin-top: 1rem;
            color: var(--accent-purple);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition);
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            width: fit-content;
        }

        .course-link:hover {
            color: var(--accent-cyan);
            gap: 0.7rem;
        }

        .course-link::after {
            content: "→";
            transition: var(--transition);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--accent-purple);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            background-color: var(--accent-purple);
            opacity: 0;
            z-index: 1000;
            animation: confettiFall 5s ease-in-out forwards;
            border-radius: 50%;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg) scale(0.5);
                opacity: 0;
            }
        }

        /* Error Message */
        .error-message {
            color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.1);
            padding: 0.75rem;
            border-radius: var(--border-radius-small);
            margin-top: 1rem;
            font-size: 0.9rem;
            border-left: 3px solid #ff6b6b;
        }

        /* Export Button */
        .export-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--gradient-green);
            color: var(--bg-darkest);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, var(--accent-green-light), var(--accent-cyan-light));
            transform: translateY(-3px) scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent-purple);
            color: var(--bg-darkest);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: var(--shadow-hover);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification.show {
            opacity: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }

            header {
                height: 60px;
                padding: 0.75rem 1rem;
            }

            .chat-container {
                padding: 1rem;
            }

            .message {
                max-width: 90%;
                padding: 0.9rem 1.2rem;
            }

            .courses-container {
                grid-template-columns: 1fr;
            }

            .export-btn {
                bottom: 1rem;
                right: 1rem;
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .text-accent {
            color: var(--accent-purple);
        }

        .text-cyan {
            color: var(--accent-cyan);
        }

        .text-green {
            color: var(--accent-green);
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Background Shapes -->
    <div id="background-shapes"></div>

    <!-- Header - Now Static -->
    <header>
        <div class="logo">NeuroBot</div>
        <div class="header-actions">
            <button class="header-button" id="new-chat-btn">
                <span class="icon">🗨️</span>
                <span>New Chat</span>
            </button>
            <button class="theme-toggle" aria-label="Toggle theme">🌓</button>
        </div>
    </header>

    <!-- Chat Container -->
    <div class="chat-container">
        <div class="chat-messages" id="chat-messages">
            <!-- Messages will be inserted here by JavaScript -->
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typing-indicator">
            <span class="typing-text">NeuroBot is typing</span>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <textarea class="chat-input" id="user-input" placeholder="Ask for course recommendations..." rows="1" autocomplete="off"></textarea>
            <button class="send-button" id="send-button">➤</button>
        </div>
    </div>

    <!-- Export Button -->
    <button class="export-btn" id="export-btn">
        <span class="icon">📤</span>
        <span>Export Chat</span>
    </button>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span class="icon">✓</span>
        <span id="notification-text">Chat exported successfully!</span>
    </div>

    <script>
        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const themeToggle = document.querySelector('.theme-toggle');
        const backgroundShapes = document.getElementById('background-shapes');
        const newChatBtn = document.getElementById('new-chat-btn');
        const exportBtn = document.getElementById('export-btn');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notification-text');

        // App State
        let conversationHistory = [];
        let currentTheme = 'dark';
        let isWaitingForResponse = false;

        // Configuration - Replace with your actual API key
        const GEMINI_API_KEY = 'processes.env.gemini_key'; // Replace with your actual API key
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // System prompt for Gemini
        const SYSTEM_PROMPT = `
        You are CourseBot, an AI assistant that helps users find the perfect online courses based on their interests and skill level.
        Your responses should be concise, friendly, and helpful. When recommending courses, provide them in a structured JSON format.

        Course recommendations should include:
        - title: The course name
        - description: A brief description (1-2 sentences)
        - category: The subject area
        - level: Beginner/Intermediate/Advanced
        - duration: Estimated time to complete
        - url: A link to the course

        Always respond with valid JSON in this format:
        {
            "response": "Your text response to the user",
            "courses": [
                {
                    "title": "Course Name",
                    "description": "Course description",
                    "category": "Category",
                    "level": "Beginner/Intermediate/Advanced",
                    "duration": "X weeks/hours",
                    "url": "https://example.com"
                }
            ],
            "quickReplies": ["Suggested", "Quick", "Replies"]
        }

        If you can't find relevant courses, just provide a helpful text response.
        `;

        // Initialize the app
        function init() {
            loadConversation();
            setupEventListeners();
            createBackgroundShapes();
            showWelcomeMessage();
            setupTextareaResize();
            scrollToBottom(true); // Initial scroll to bottom
        }

        // Set up event listeners
        function setupEventListeners() {
            // Send message on button click
            sendButton.addEventListener('click', sendMessage);

            // Send message on Enter key (but allow Shift+Enter for new lines)
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !isWaitingForResponse) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Theme toggle
            themeToggle.addEventListener('click', toggleTheme);

            // New chat button
            newChatBtn.addEventListener('click', startNewChat);

            // Export button
            exportBtn.addEventListener('click', exportChat);

            // Enable/disable send button based on input
            userInput.addEventListener('input', () => {
                sendButton.disabled = userInput.value.trim() === '' || isWaitingForResponse;
            });

            // Auto-scroll when new messages are added
            const observer = new MutationObserver(scrollToBottom);
            observer.observe(chatMessages, { childList: true, subtree: true });
        }

        // Set up auto-resize for textarea
        function setupTextareaResize() {
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }

        // Create floating background shapes
        function createBackgroundShapes() {
            const colors = ['var(--accent-purple)', 'var(--accent-cyan)', 'var(--accent-green)'];
            const shapeTypes = ['circle', 'triangle', 'square'];
            
            for (let i = 0; i < 20; i++) {
                const shape = document.createElement('div');
                const size = Math.random() * 100 + 30;
                const type = shapeTypes[Math.floor(Math.random() * shapeTypes.length)];
                
                shape.className = `shape ${type}`;
                
                if (type === 'circle' || type === 'square') {
                    shape.style.width = `${size}px`;
                    shape.style.height = `${size}px`;
                }
                
                shape.style.left = `${Math.random() * 100}%`;
                shape.style.top = `${Math.random() * 100}%`;
                shape.style.animationDelay = `${Math.random() * 20}s`;
                shape.style.animationDuration = `${Math.random() * 15 + 10}s`;
                
                backgroundShapes.appendChild(shape);
            }
        }

        // Toggle between dark and light theme
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', currentTheme);
            themeToggle.textContent = currentTheme === 'dark' ? '🌓' : '🌒';
            localStorage.setItem('chatbotTheme', currentTheme);
        }

        // Start a new chat
        function startNewChat() {
            if (conversationHistory.length > 0) {
                if (confirm('Start a new chat? Your current conversation will be cleared.')) {
                    conversationHistory = [];
                    saveConversation();
                    chatMessages.innerHTML = '';
                    showWelcomeMessage();
                    scrollToBottom(true);
                }
            }
        }

        // Export chat to text file
        function exportChat() {
            if (conversationHistory.length === 0) {
                showNotification('No conversation to export', 'error');
                return;
            }

            let exportText = 'CourseBot Conversation\n=====================\n\n';
            
            conversationHistory.forEach(msg => {
                const timestamp = new Date(msg.timestamp).toLocaleString();
                exportText += `${msg.sender === 'user' ? 'You' : 'CourseBot'} (${timestamp}):\n`;
                exportText += `${msg.content}\n\n`;
                
                if (msg.courses) {
                    exportText += 'Recommended Courses:\n';
                    msg.courses.forEach(course => {
                        exportText += `- ${course.title} (${course.level}, ${course.duration})\n`;
                        exportText += `  ${course.description}\n`;
                        exportText += `  URL: ${course.url}\n\n`;
                    });
                }
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `coursebot-chat-${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Chat exported successfully!');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            
            if (type === 'error') {
                notification.style.backgroundColor = '#ff6b6b';
            } else {
                notification.style.backgroundColor = 'var(--accent-purple)';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Load conversation from local storage
        function loadConversation() {
            const savedTheme = localStorage.getItem('chatbotTheme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.body.setAttribute('data-theme', currentTheme);
                themeToggle.textContent = currentTheme === 'dark' ? '🌓' : '🌒';
            }

            const savedConversation = localStorage.getItem('chatbotConversation');
            if (savedConversation) {
                conversationHistory = JSON.parse(savedConversation);
                renderConversation();
            }
        }

        // Save conversation to local storage
        function saveConversation() {
            localStorage.setItem('chatbotConversation', JSON.stringify(conversationHistory));
        }

        // Show welcome message
        function showWelcomeMessage() {
            if (conversationHistory.length === 0) {
                const welcomeMessage = {
                    sender: 'bot',
                    content: "Hi there! 👋 I'm CourseBot, your personal course recommendation assistant. I can help you find the perfect courses based on your interests and skill level.",
                    timestamp: new Date().toISOString()
                };

                const categoriesMessage = {
                    sender: 'bot',
                    content: "Here are some categories I can recommend courses for:",
                    quickReplies: ["Programming", "Design", "Business", "Data Science", "Marketing"],
                    timestamp: new Date().toISOString()
                };

                conversationHistory.push(welcomeMessage, categoriesMessage);
                renderMessage(welcomeMessage);
                renderMessage(categoriesMessage);
                saveConversation();
            }
        }

        // Render the entire conversation
        function renderConversation() {
            chatMessages.innerHTML = '';
            conversationHistory.forEach(message => {
                renderMessage(message);
            });
            scrollToBottom(true);
        }

        // Render a single message
        function renderMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.sender}-message`;
            
            const timeString = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (message.sender === 'bot') {
                let contentHTML = `<p>${message.content}</p>`;
                contentHTML += `<span class="message-time">${timeString}</span>`;
                messageElement.innerHTML = contentHTML;
                
                if (message.quickReplies) {
                    const quickRepliesContainer = document.createElement('div');
                    quickRepliesContainer.className = 'quick-replies mt-1';
                    
                    message.quickReplies.forEach(reply => {
                        const button = document.createElement('button');
                        button.className = 'quick-reply';
                        button.textContent = reply;
                        button.addEventListener('click', () => {
                            userInput.value = reply;
                            sendMessage();
                        });
                        quickRepliesContainer.appendChild(button);
                    });
                    
                    messageElement.appendChild(quickRepliesContainer);
                }
                
                if (message.courses) {
                    const coursesContainer = document.createElement('div');
                    coursesContainer.className = 'courses-container mt-1';
                    
                    message.courses.forEach(course => {
                        const courseCard = document.createElement('div');
                        courseCard.className = 'course-card';
                        courseCard.innerHTML = `
                            <h3>${course.title}</h3>
                            <p>${course.description}</p>
                            <div class="course-meta">
                                <span class="course-category">${course.category}</span>
                                <span class="course-level ${course.level.toLowerCase()}">${course.level}</span>
                            </div>
                            <div class="course-meta">
                                <span class="course-duration">⏱️ ${course.duration}</span>
                            </div>
                            <a href="${course.url}" class="course-link" target="_blank">View Course</a>
                        `;
                        courseCard.addEventListener('click', () => showConfetti());
                        coursesContainer.appendChild(courseCard);
                    });
                    
                    messageElement.appendChild(coursesContainer);
                }

                if (message.error) {
                    const errorElement = document.createElement('div');
                    errorElement.className = 'error-message mt-1';
                    errorElement.textContent = message.error;
                    messageElement.appendChild(errorElement);
                }
            } else {
                messageElement.innerHTML = `
                    <p>${message.content}</p>
                    <span class="message-time">${timeString}</span>
                `;
            }
            
            chatMessages.appendChild(messageElement);
        }

        // Show typing indicator
        function showTypingIndicator() {
            typingIndicator.classList.add('active');
            scrollToBottom();
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            typingIndicator.classList.remove('active');
        }

        // Scroll chat to bottom
        function scrollToBottom(force = false) {
            // Only scroll if we're near the bottom or forced
            const threshold = 100; // pixels from bottom
            const isNearBottom = chatMessages.scrollHeight - chatMessages.clientHeight - chatMessages.scrollTop <= threshold;
            
            if (force || isNearBottom) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 50);
            }
        }

        // Send user message
        async function sendMessage() {
            const messageText = userInput.value.trim();
            if (messageText === '' || isWaitingForResponse) return;

            // Create and display user message
            const userMessage = {
                sender: 'user',
                content: messageText,
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(userMessage);
            renderMessage(userMessage);
            saveConversation();
            
            // Clear input and disable send button
            userInput.value = '';
            userInput.style.height = 'auto';
            sendButton.disabled = true;
            isWaitingForResponse = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Call Gemini API
                const botResponse = await callGeminiAPI(messageText);
                
                // Add to conversation history
                conversationHistory.push(botResponse);
                renderMessage(botResponse);
                saveConversation();
            } catch (error) {
                console.error("API Error:", error);
                
                const errorMessage = {
                    sender: 'bot',
                    content: "I'm having trouble connecting to the course database right now.",
                    error: "Error: " + (error.message || "Failed to get recommendations"),
                    timestamp: new Date().toISOString(),
                    quickReplies: ["Try again", "Different query", "Help"]
                };
                
                conversationHistory.push(errorMessage);
                renderMessage(errorMessage);
                saveConversation();
            } finally {
                hideTypingIndicator();
                isWaitingForResponse = false;
            }
        }

        // Call Gemini API
        async function callGeminiAPI(userMessage) {
            // Prepare the conversation history for the API
            const messages = [
                {
                    role: "user",
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                {
                    role: "model",
                    parts: [{ text: "Understood. I will provide course recommendations in the specified JSON format." }]
                }
            ];

            // Add the conversation history (last 5 messages for context)
            const recentHistory = conversationHistory.slice(-5);
            recentHistory.forEach(msg => {
                messages.push({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.content }]
                });
            });

            // Add the current user message
            messages.push({
                role: "user",
                parts: [{ text: userMessage }]
            });

            const requestBody = {
                contents: messages,
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 2000
                }
            };

            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }

            const data = await response.json();
            
            // Extract the response text
            let responseText = '';
            try {
                responseText = data.candidates[0].content.parts[0].text;
                
                // Try to parse the JSON response
                let parsedResponse;
                try {
                    // Sometimes the response includes markdown code blocks
                    const jsonMatch = responseText.match(/```json\n([\s\S]*?)\n```/);
                    if (jsonMatch) {
                        parsedResponse = JSON.parse(jsonMatch[1]);
                    } else {
                        parsedResponse = JSON.parse(responseText);
                    }
                } catch (e) {
                    // If parsing fails, treat the whole response as text
                    parsedResponse = {
                        response: responseText,
                        courses: null,
                        quickReplies: ["More options", "Different category", "Thanks!"]
                    };
                }

                // Create the bot response object
                return {
                    sender: 'bot',
                    content: parsedResponse.response || responseText,
                    courses: parsedResponse.courses || null,
                    quickReplies: parsedResponse.quickReplies || ["More options", "Different category", "Thanks!"],
                    timestamp: new Date().toISOString()
                };
            } catch (e) {
                console.error("Error parsing API response:", e);
                return {
                    sender: 'bot',
                    content: responseText || "Here are some course recommendations based on your query:",
                    timestamp: new Date().toISOString(),
                    quickReplies: ["More options", "Different category", "Thanks!"]
                };
            }
        }

        // Show confetti animation
        function showConfetti() {
            for (let i = 0; i < 100; i++) {
                createConfettiPiece();
            }
        }

        // Create a single confetti piece
        function createConfettiPiece() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            
            // Random properties
            const colors = ['var(--accent-purple)', 'var(--accent-cyan)', 'var(--accent-green)'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const size = Math.random() * 12 + 6;
            const left = Math.random() * window.innerWidth;
            const animationDuration = Math.random() * 3 + 2;
            const delay = Math.random() * 2;
            
            confetti.style.backgroundColor = color;
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size}px`;
            confetti.style.left = `${left}px`;
            confetti.style.animationDuration = `${animationDuration}s`;
            confetti.style.animationDelay = `${delay}s`;
            
            document.body.appendChild(confetti);
            
            // Remove confetti after animation
            setTimeout(() => {
                confetti.remove();
            }, (animationDuration + delay) * 1000);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
