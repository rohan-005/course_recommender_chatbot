<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroPath - Course Recommendation Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a12;
            --bg-darker: #07070f;
            --primary: #6e44ff;
            --primary-dark: #5a2dff;
            --accent: #00f5d4;
            --accent-dark: #00c7a8;
            --text-light: #e0e0e0;
            --text-muted: #a0a0a0;
            --success: #00ffaa;
            --success-dark: #00cc88;
            --border: #2a2a3a;
            --terminal-bg: rgba(10, 10, 20, 0.9);
            --terminal-text: #00ffaa;
            --terminal-cursor: #00ffaa;
            --glow: 0 0 15px rgba(0, 245, 212, 0.5);
            --neon-glow: 0 0 10px rgba(110, 68, 255, 0.7);
            --border-radius: 8px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
    
        body {
            font-family: 'Courier New', monospace, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }
    
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }
    
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
    
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: var(--border-radius);
            background: var(--terminal-bg);
            border: 1px solid var(--border);
            box-shadow: var(--glow);
            position: relative;
            overflow: hidden;
        }
    
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: scanline 3s linear infinite;
        }
    
        @keyframes scanline {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    
        h1 {
            margin: 0;
            font-size: 2.5rem;
            background: linear-gradient(to right, var(--accent), var(--primary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: 1px;
            font-weight: 700;
            text-shadow: var(--neon-glow);
        }
    
        header p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }
    
        .chat-container {
            background: var(--terminal-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            box-shadow: var(--glow);
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
    
        #chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
            background: rgba(0, 0, 0, 0.2);
        }
    
        .message {
            margin-bottom: 15px;
            max-width: 80%;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            line-height: 1.5;
            position: relative;
            animation: fadeIn 0.4s ease;
            transition: var(--transition);
            border-left: 3px solid;
        }
    
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        .user-message {
            background: rgba(110, 68, 255, 0.15);
            margin-left: auto;
            border-left-color: var(--primary);
        }
    
        .user-message:hover {
            background: rgba(110, 68, 255, 0.25);
            box-shadow: var(--neon-glow);
        }
    
        .bot-message {
            background: rgba(30, 30, 45, 0.7);
            margin-right: auto;
            border-left-color: var(--accent);
        }
    
        .bot-message:hover {
            background: rgba(30, 30, 45, 0.9);
            box-shadow: var(--glow);
        }
    
        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-weight: bold;
        }
    
        .user-avatar, .bot-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
            font-weight: bold;
        }
    
        .user-avatar {
            background-color: var(--primary);
            color: white;
            box-shadow: var(--neon-glow);
        }
    
        .bot-avatar {
            background-color: var(--accent);
            color: var(--bg-dark);
            box-shadow: var(--glow);
        }
    
        .message-time {
            font-size: 11px;
            color: var(--text-muted);
            text-align: right;
            margin-top: 5px;
        }
    
        .input-area {
            display: flex;
            padding: 15px;
            background: var(--bg-darker);
            border-top: 1px solid var(--border);
            position: relative;
        }
    
        #user-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(20, 20, 35, 0.8);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            outline: none;
            font-family: 'Courier New', monospace;
            color: var(--text-light);
            font-size: 16px;
            transition: var(--transition);
        }
    
        #user-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 245, 212, 0.3);
        }
    
        #user-input::placeholder {
            color: var(--text-muted);
        }
    
        #send-btn, #export-btn {
            margin-left: 10px;
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    
        #send-btn {
            background: var(--primary);
            box-shadow: var(--neon-glow);
        }
    
        #send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
    
        #export-btn {
            background: var(--success);
            box-shadow: 0 0 10px rgba(0, 255, 170, 0.5);
        }
    
        #export-btn:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
        }
    
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 12px 18px;
            background: rgba(30, 30, 45, 0.7);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            width: fit-content;
            border-left: 3px solid var(--accent);
        }
    
        .typing-text {
            margin-right: 10px;
            font-size: 14px;
            color: var(--text-muted);
        }
    
        .typing-dots {
            display: flex;
        }
    
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: var(--accent);
            border-radius: 50%;
            margin: 0 3px;
            animation: bounce 1.4s infinite ease-in-out;
        }
    
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
        }
    
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
    
        .quick-reply {
            padding: 6px 12px;
            background: rgba(0, 245, 212, 0.1);
            border: 1px solid var(--accent);
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }
    
        .quick-reply:hover {
            background: rgba(0, 245, 212, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }
    
        .course-card {
            background: rgba(20, 20, 35, 0.7);
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            transition: var(--transition);
        }
    
        .course-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: var(--glow);
        }
    
        .course-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--accent);
        }
    
        .course-description {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
    
        .course-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 13px;
            color: var(--text-muted);
        }
    
        .course-rating {
            color: #f39c12;
        }
    
        .course-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }
    
        .btn {
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
    
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--neon-glow);
        }
    
        .btn-accent {
            background: var(--accent);
            color: var(--bg-dark);
        }
    
        .btn-accent:hover {
            background: var(--accent-dark);
            box-shadow: var(--glow);
        }
    
        /* Terminal-like cursor effect */
        .terminal-cursor {
            display: inline-block;
            width: 10px;
            height: 16px;
            background: var(--terminal-cursor);
            animation: blink 1s infinite;
            vertical-align: middle;
            margin-left: 2px;
        }
    
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .quiz-container {
        background: rgba(20, 20, 35, 0.9);
        border-radius: var(--border-radius);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
        box-shadow: var(--glow);
    }

    .quiz-question {
        font-weight: bold;
        margin-bottom: 15px;
        color: var(--accent);
        font-size: 1.1rem;
    }

    .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .quiz-option {
        padding: 12px 15px;
        background: rgba(30, 30, 45, 0.7);
        border: 1px solid var(--border);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .quiz-option:hover {
        background: rgba(110, 68, 255, 0.2);
        border-color: var(--primary);
        transform: translateX(5px);
        box-shadow: var(--neon-glow);
    }

    .quiz-option::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: var(--primary);
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }

    .quiz-option:hover::before {
        transform: scaleY(1);
    }

    .quiz-option.selected {
        background: rgba(110, 68, 255, 0.3);
        border-color: var(--primary);
        box-shadow: var(--neon-glow);
    }

    .quiz-option.selected::before {
        transform: scaleY(1);
    }

    .quiz-progress {
        height: 4px;
        background: var(--border);
        border-radius: 2px;
        margin-top: 20px;
        overflow: hidden;
    }

    .quiz-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        width: 50%; /* Adjust based on actual progress */
        transition: width 0.5s ease;
    }

    .quiz-instruction {
        color: var(--text-muted);
        font-size: 0.9rem;
        margin-top: 15px;
        font-style: italic;
    }
    
        /* Floating action button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--accent);
            color: var(--bg-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--glow);
            transition: var(--transition);
            z-index: 100;
        }
    
        .fab:hover {
            transform: scale(1.1);
        }
    
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
    
            .chat-container {
                height: 80vh;
            }
    
            .input-area {
                flex-wrap: wrap;
            }
    
            #user-input {
                width: 100%;
                margin-bottom: 10px;
            }
    
            #send-btn, #export-btn {
                flex: 1;
                margin-left: 0;
            }
    
            .message {
                max-width: 90%;
            }
    
            .fab {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
    
    <div id="particles-js"></div>
    <div class="container">
        <header>
            <h1>NeuroPath<span class="terminal-cursor"></span></h1>
            <p>AI-Powered Learning Assistant</p>
        </header>
        
        <div class="chat-container">
            <div id="chat-messages">
                <!-- Initial bot message -->
                <div class="message bot-message">
                    <div class="message-header">
                        <div class="bot-avatar">AI</div>
                        <strong>NeuroPath</strong>
                    </div>
                    <p>Hello, user! I'm your AI-powered learning assistant. How can I help you today?</p>
                    <div class="quick-replies">
                        <div class="quick-reply">Find courses</div>
                        <div class="quick-reply">Take a quiz</div>
                        <div class="quick-reply">Get recommendations</div>
                    </div>
                    <div class="message-time">System: Online</div>
                </div>
            </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="Type a command..." autocomplete="off">
                <button id="send-btn">Send</button>
                <button id="export-btn">Export</button>
            </div>
        </div>
    </div>
    
    <!-- Floating action button -->
    <div class="fab" id="scroll-to-bottom">
        ↓
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Course Database - Enhanced with more courses
        const courses = [
            // Web Development
            {
                id: 1,
                name: "The Web Developer Bootcamp 2024",
                domain: "Web Development",
                level: "Beginner",
                duration: "8 weeks",
                rating: 4.8,
                keywords: ["html", "css", "javascript", "frontend", "fullstack"],
                description: "The most comprehensive course on web development. Become a full-stack web developer with just one course.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/the-web-developer-bootcamp/"
            },
            {
                id: 2,
                name: "HTML, CSS, and JavaScript for Web Developers",
                domain: "Web Development",
                level: "Beginner",
                duration: "6 weeks",
                rating: 4.7,
                keywords: ["html5", "css3", "javascript", "responsive"],
                description: "Learn the basic tools of web development: HTML, CSS and JavaScript.",
                platform: "Coursera",
                url: "https://www.coursera.org/learn/html-css-javascript-for-web-developers"
            },
            {
                id: 3,
                name: "React - The Complete Guide",
                domain: "Web Development",
                level: "Intermediate",
                duration: "8 weeks",
                rating: 4.7,
                keywords: ["react", "javascript", "frontend", "hooks"],
                description: "Dive in and learn React.js from scratch! Learn React, Hooks, Redux, React Router, and more.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/react-the-complete-guide-incl-redux/"
            },
            
            // Data Science
            {
                id: 4,
                name: "Data Science Specialization",
                domain: "Data Science",
                level: "Intermediate",
                duration: "10 weeks",
                rating: 4.8,
                keywords: ["python", "r", "statistics", "machine learning"],
                description: "Launch your career in data science. Master data analysis, visualization, and machine learning.",
                platform: "Coursera",
                url: "https://www.coursera.org/specializations/jhu-data-science"
            },
            {
                id: 5,
                name: "Python for Data Science and Machine Learning",
                domain: "Data Science",
                level: "Intermediate",
                duration: "9 weeks",
                rating: 4.6,
                keywords: ["python", "pandas", "numpy", "scikit-learn"],
                description: "Learn how to use NumPy, Pandas, Seaborn, Matplotlib, Scikit-Learn, and more for Machine Learning.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/python-for-data-science-and-machine-learning-bootcamp/"
            },
            {
                id: 6,
                name: "Machine Learning A-Z",
                domain: "Data Science",
                level: "Intermediate",
                duration: "12 weeks",
                rating: 4.9,
                keywords: ["machine learning", "ai", "python", "data analysis"],
                description: "Hands-on Python and R in data science with real-world applications of machine learning.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/machinelearning/"
            },
            
            // Mobile Development
            {
                id: 7,
                name: "Flutter & Dart - The Complete Guide",
                domain: "Mobile Development",
                level: "Intermediate",
                duration: "10 weeks",
                rating: 4.7,
                keywords: ["flutter", "dart", "mobile", "cross-platform"],
                description: "Build native mobile apps for iOS and Android using Flutter's revolutionary framework.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/learn-flutter-dart-to-build-ios-android-apps/"
            },
            {
                id: 8,
                name: "Android Kotlin Development",
                domain: "Mobile Development",
                level: "Intermediate",
                duration: "8 weeks",
                rating: 4.5,
                keywords: ["android", "kotlin", "mobile", "app development"],
                description: "Learn how to build professional Android apps using Kotlin and industry-standard tools.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/android-kotlin-developer/"
            },
            {
                id: 9,
                name: "iOS & Swift - The Complete iOS App Development Bootcamp",
                domain: "Mobile Development",
                level: "Intermediate",
                duration: "12 weeks",
                rating: 4.8,
                keywords: ["ios", "swift", "apple", "mobile"],
                description: "From beginner to iOS app developer with just one course - fully updated for iOS 15 and Swift 5.5.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/ios-13-app-development-bootcamp/"
            },
            
            // Design
            {
                id: 10,
                name: "UI/UX Design Specialization",
                domain: "Design",
                level: "Beginner",
                duration: "12 weeks",
                rating: 4.7,
                keywords: ["ui", "ux", "design", "figma"],
                description: "Design high-impact user experiences. Research, design, and prototype effective interfaces.",
                platform: "Coursera",
                url: "https://www.coursera.org/specializations/ui-ux-design"
            },
            // Example additional courses
            {
                id: 21,
                name: "Complete Python Bootcamp",
                domain: "Programming",
                level: "Beginner",
                duration: "6 weeks",
                rating: 4.6,
                keywords: ["python", "programming", "beginners"],
                description: "Learn Python like a Professional! Start from the basics and go all the way to creating your own applications.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/complete-python-bootcamp/"
            },
            {
                id: 22,
                name: "Advanced CSS and Sass",
                domain: "Web Development",
                level: "Advanced",
                duration: "5 weeks",
                rating: 4.7,
                keywords: ["css", "sass", "frontend", "responsive"],
                description: "Master advanced CSS3 and Sass with flexbox, grid, animations and more!",
                platform: "Udemy",
                url: "https://www.udemy.com/course/advanced-css-and-sass/"
            },
            {
                id: 11,
                name: "Google UX Design Professional Certificate",
                domain: "Design",
                level: "Beginner",
                duration: "6 months",
                rating: 4.8,
                keywords: ["ux", "design", "research", "prototyping"],
                description: "Get job-ready for an entry-level role in UX design with this professional certificate.",
                platform: "Coursera",
                url: "https://www.coursera.org/professional-certificates/google-ux-design"
            },
            {
                id: 12,
                name: "Graphic Design Masterclass",
                domain: "Design",
                level: "Beginner",
                duration: "8 weeks",
                rating: 4.6,
                keywords: ["photoshop", "illustrator", "design", "graphics"],
                description: "Learn graphic design with Photoshop, Illustrator, and InDesign while designing real-world projects.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/graphic-design-masterclass-everything-you-need-to-know/"
            },
            
            // Cybersecurity
            {
                id: 13,
                name: "Cybersecurity Specialization",
                domain: "Security",
                level: "Intermediate",
                duration: "5 months",
                rating: 4.7,
                keywords: ["security", "cybersecurity", "networking", "encryption"],
                description: "Develop knowledge of cybersecurity tools and attacks to protect systems and data.",
                platform: "Coursera",
                url: "https://www.coursera.org/specializations/cyber-security"
            },
            {
                id: 14,
                name: "The Complete Cyber Security Course",
                domain: "Security",
                level: "Intermediate",
                duration: "12 weeks",
                rating: 4.6,
                keywords: ["hacking", "security", "privacy", "anonymity"],
                description: "Become a cybersecurity specialist by learning network security, cryptography, and ethical hacking.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/the-complete-internet-security-privacy-course-volume-1/"
            },
            {
                id: 15,
                name: "Ethical Hacking from Scratch",
                domain: "Security",
                level: "Intermediate",
                duration: "10 weeks",
                rating: 4.5,
                keywords: ["ethical hacking", "penetration testing", "security", "kali linux"],
                description: "Learn ethical hacking from scratch with hands-on demonstrations of penetration testing.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/learn-ethical-hacking-from-scratch/"
            },
            
            // DevOps
            {
                id: 16,
                name: "DevOps Beginners to Advanced",
                domain: "DevOps",
                level: "Intermediate",
                duration: "8 weeks",
                rating: 4.5,
                keywords: ["devops", "docker", "kubernetes", "ci/cd"],
                description: "Learn DevOps from scratch with hands-on projects covering Docker, Kubernetes, and more.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/devops-essentials/"
            },
            {
                id: 17,
                name: "Docker and Kubernetes: The Complete Guide",
                domain: "DevOps",
                level: "Intermediate",
                duration: "6 weeks",
                rating: 4.7,
                keywords: ["docker", "kubernetes", "containers", "microservices"],
                description: "Build, test, and deploy Docker applications with Kubernetes while learning production-style workflows.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/docker-and-kubernetes-the-complete-guide/"
            },
            {
                id: 18,
                name: "AWS Certified DevOps Engineer Professional",
                domain: "DevOps",
                level: "Advanced",
                duration: "10 weeks",
                rating: 4.6,
                keywords: ["aws", "devops", "cloud", "automation"],
                description: "Pass the AWS Certified DevOps Engineer Professional certification with this comprehensive course.",
                platform: "Udemy",
                url: "https://www.udemy.com/course/aws-certified-devops-engineer-professional-hands-on/"
            },
            
            // Additional courses
            {
                id: 19,
                name: "Full Stack Open 2024",
                domain: "Web Development",
                level: "Intermediate",
                duration: "12 weeks",
                rating: 4.8,
                keywords: ["react", "node", "mongodb", "graphql"],
                description: "Learn React, Redux, Node.js, MongoDB, GraphQL and TypeScript in one go!",
                platform: "University of Helsinki",
                url: "https://fullstackopen.com/en/"
            },
            {
                id: 20,
                name: "IBM Data Science Professional Certificate",
                domain: "Data Science",
                level: "Beginner",
                duration: "3 months",
                rating: 4.6,
                keywords: ["python", "data analysis", "machine learning", "ibm"],
                description: "Kickstart your career in data science with this professional certificate from IBM.",
                platform: "Coursera",
                url: "https://www.coursera.org/professional-certificates/ibm-data-science"
            }
        ];

        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const exportBtn = document.getElementById('export-btn');

        // Conversation State
        let conversationState = {
            step: 'welcome',
            preferences: {
                domain: null,
                level: null,
                duration: null,
                rating: null,
                keywords: []
            },
            quizAnswers: [],
            recommendedCourses: []
        };

        // Natural Language Processing Helpers
        const levelKeywords = {
            'beginner': ['beginner', 'new', 'starting', 'intro', 'basic', 'novice', 'first time'],
            'intermediate': ['intermediate', 'some experience', 'familiar', 'comfortable', 'moderate'],
            'advanced': ['advanced', 'expert', 'professional', 'experienced', 'master']
        };

        const durationKeywords = {
            'short': ['short', 'quick', 'brief', 'fast', '1-2 weeks', '2 weeks', '1 month'],
            'medium': ['medium', 'moderate', '4 weeks', '6 weeks', '1-2 months'],
            'long': ['long', 'extensive', '8 weeks', '10 weeks', '12 weeks', '3 months']
        };

        // Initialize the chat
        document.addEventListener('DOMContentLoaded', () => {
            // Load conversation state from session storage if available
            const savedState = sessionStorage.getItem('eduBotState');
            if (savedState) {
                conversationState = JSON.parse(savedState);
                // Re-render the conversation based on saved state
                renderBasedOnState();
            } else {
                // Start new conversation
                showWelcomeMessage();
            }

            // Initialize particles.js
            initParticles();
        });

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        exportBtn.addEventListener('click', exportRecommendations);

        // Function to send message
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            // Add user message to chat
            addMessage(message, 'user');

            // Clear input
            userInput.value = '';

            // Show typing indicator
            showTypingIndicator();

            // Process user message after a short delay
            setTimeout(() => {
                processUserMessage(message);
            }, 500);
        }

        // Function to add message to chat
        function addMessage(text, sender, isHTML = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            
            if (isHTML) {
                messageDiv.innerHTML = text;
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Function to show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('typing-indicator');
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        // Function to hide typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            scrollToBottom();
        }

        // Function to scroll to bottom of chat
        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }

        // Function to process user message based on current conversation state
        function processUserMessage(message) {
            // Hide typing indicator
            hideTypingIndicator();

            // Save the conversation state
            saveConversationState();

            // Process based on current step
            switch (conversationState.step) {
                case 'welcome':
                    handleWelcomeResponse(message);
                    break;
                case 'domain':
                    handleDomainSelection(message);
                    break;
                case 'level':
                    handleLevelSelection(message);
                    break;
                case 'duration':
                    handleDurationSelection(message);
                    break;
                case 'rating':
                    handleRatingSelection(message);
                    break;
                case 'keywords':
                    handleKeywordsSelection(message);
                    break;
                case 'quiz':
                    handleQuizResponse(message);
                    break;
                case 'recommendations':
                    handleRecommendationResponse(message);
                    break;
                default:
                    handleDefaultResponse(message);
            }
        }

        // Welcome message and initial setup
        function showWelcomeMessage() {
            const welcomeMessage = `
                <p>Hello! I'm NeuroPath, your personal course recommendation assistant.</p>
                <p>I can help you find the perfect courses based on your preferences and skill level.</p>
                <p>Would you like to:</p>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="selectOption('Start with a skill assessment quiz')">Start with a skill assessment quiz</button>
                    <button class="btn" onclick="selectOption('Set preferences directly')">Set preferences directly</button>
                </div>
                <p class="mt-1"><small>You can also just type your answer.</small></p>
            `;
            addMessage(welcomeMessage, 'bot', true);
        }

        // Handle welcome response
        function handleWelcomeResponse(message) {
            const lowerMsg = message.toLowerCase();
            
            if (lowerMsg.includes('quiz') || lowerMsg.includes('assessment') || lowerMsg.includes('test')) {
                conversationState.step = 'quiz';
                startQuiz();
            } else if (lowerMsg.includes('prefer') || lowerMsg.includes('direct') || lowerMsg.includes('set')) {
                conversationState.step = 'domain';
                askAboutDomain();
            } else {
                // If unclear, ask for clarification
                const clarification = `
                    <p>I'm not sure what you'd like to do. Would you prefer to:</p>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="selectOption('Take the skill assessment quiz')">Take the skill assessment quiz</button>
                        <button class="btn" onclick="selectOption('Set preferences directly')">Set preferences directly</button>
                    </div>
                `;
                addMessage(clarification, 'bot', true);
            }
        }

        // Quiz functionality
        function startQuiz() {
            conversationState.quizAnswers = [];
            showQuizQuestion(0);
        }

        // Quiz questions
        const quizQuestions = [
            {
                question: "How would you rate your programming experience?",
                options: [
                    "No experience (just starting out)",
                    "Beginner (can write simple programs)",
                    "Intermediate (comfortable with one language)",
                    "Advanced (can build complex applications)"
                ],
                field: "level"
            },
            {
                question: "What area are you most interested in learning about?",
                options: [
                    "Web Development",
                    "Data Science",
                    "Mobile Development",
                    "Design",
                    "Cybersecurity",
                    "DevOps"
                ],
                field: "domain"
            },
            {
                question: "How much time can you dedicate to learning each week?",
                options: [
                    "Less than 2 hours",
                    "2-5 hours",
                    "5-10 hours",
                    "More than 10 hours"
                ],
                field: "duration"
            },
            {
                question: "Do you prefer courses with hands-on projects?",
                options: [
                    "Yes, definitely",
                    "Somewhat",
                    "Not particularly",
                    "No preference"
                ],
                field: "projects"
            }
        ];

        // Show quiz question
        function showQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                // Quiz completed
                conversationState.step = 'recommendations';
                recommendCourses();
                return;
            }

            const question = quizQuestions[index];
            let optionsHTML = question.options.map(opt => 
                `<div class="quiz-option" onclick="selectQuizOption(${index}, '${opt}')">${opt}</div>`
            ).join('');

            const questionHTML = `
                <div class="quiz-question">
                    <p><strong>Question ${index + 1}/${quizQuestions.length}:</strong> ${question.question}</p>
                    <div class="quiz-options">
                        ${optionsHTML}
                    </div>
                    <p class="mt-1"><small>You can type your answer or select an option above.</small></p>
                </div>
            `;

            addMessage(questionHTML, 'bot', true);
        }

        // Handle quiz response (text input)
        function handleQuizResponse(message) {
            const currentQuestionIndex = conversationState.quizAnswers.length;
            if (currentQuestionIndex >= quizQuestions.length) {
                conversationState.step = 'recommendations';
                recommendCourses();
                return;
            }

            const question = quizQuestions[currentQuestionIndex];
            let matchedOption = null;

            // Try to match the user's input to one of the options
            const lowerMsg = message.toLowerCase();
            for (const option of question.options) {
                if (lowerMsg.includes(option.toLowerCase().split(' ')[0])) {
                    matchedOption = option;
                    break;
                }
            }

            // For level question, use NLP to detect level
            if (question.field === 'level' && !matchedOption) {
                matchedOption = detectLevelFromText(message);
            }

            // For domain question, try to match domains
            if (question.field === 'domain' && !matchedOption) {
                const domains = [...new Set(courses.map(c => c.domain))];
                for (const domain of domains) {
                    if (lowerMsg.includes(domain.toLowerCase())) {
                        matchedOption = domain;
                        break;
                    }
                }
            }

            // For duration question, try to detect duration preference
            if (question.field === 'duration' && !matchedOption) {
                matchedOption = detectDurationFromText(message);
                if (matchedOption) {
                    // Map the detected duration to quiz options
                    if (matchedOption === "Less than 2 hours") matchedOption = "Less than 2 hours";
                    else if (matchedOption === "2-5 hours") matchedOption = "2-5 hours";
                    else if (matchedOption === "5-10 hours") matchedOption = "5-10 hours";
                    else if (matchedOption === "More than 10 hours") matchedOption = "More than 10 hours";
                }
            }

            if (matchedOption) {
                // If we matched an option, proceed as if they clicked it
                selectQuizOption(currentQuestionIndex, matchedOption);
            } else {
                // If no match, show the question again with options
                addMessage("I'm not sure I understand your answer. Please select one of the options:", 'bot');
                showQuizQuestion(currentQuestionIndex);
            }
        }

        // Detect skill level from text
        function detectLevelFromText(text) {
            const lowerText = text.toLowerCase();
            for (const [level, keywords] of Object.entries(levelKeywords)) {
                if (keywords.some(kw => lowerText.includes(kw))) {
                    return level.charAt(0).toUpperCase() + level.slice(1);
                }
            }
            return null;
        }

        // Detect duration preference from text
        function detectDurationFromText(text) {
            const lowerText = text.toLowerCase();
            
            // Check for specific hour numbers
            const hourMatch = lowerText.match(/(\d+)\s*hour/);
            if (hourMatch) {
                const hours = parseInt(hourMatch[1]);
                if (hours <= 2) return "Less than 2 hours";
                if (hours <= 5) return "2-5 hours";
                if (hours <= 10) return "5-10 hours";
                return "More than 10 hours";
            }
            
            // Check for specific week numbers
            const weekMatch = lowerText.match(/(\d+)\s*week/);
            if (weekMatch) {
                const weeks = parseInt(weekMatch[1]);
                if (weeks <= 4) return "Less than 2 hours";
                if (weeks <= 6) return "2-5 hours";
                if (weeks <= 10) return "5-10 hours";
                return "More than 10 hours";
            }
            
            // Check for duration keywords
            for (const [durationType, keywords] of Object.entries(durationKeywords)) {
                if (keywords.some(kw => lowerText.includes(kw))) {
                    if (durationType === 'short') return "Less than 2 hours";
                    if (durationType === 'medium') return "2-5 hours";
                    if (durationType === 'long') return "More than 10 hours";
                }
            }
            
            return null;
        }

        // Handle quiz option selection
        function selectQuizOption(questionIndex, option) {
            // Highlight selected option
            const quizOptions = document.querySelectorAll('.quiz-option');
            quizOptions.forEach((opt, idx) => {
                if (opt.textContent === option) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            // Save answer
            const question = quizQuestions[questionIndex];
            conversationState.quizAnswers.push({
                question: question.question,
                answer: option,
                field: question.field
            });

            // Update preferences based on answer
            if (question.field === 'level') {
                if (option.includes('No experience')) conversationState.preferences.level = 'Beginner';
                else if (option.includes('Beginner')) conversationState.preferences.level = 'Beginner';
                else if (option.includes('Intermediate')) conversationState.preferences.level = 'Intermediate';
                else if (option.includes('Advanced')) conversationState.preferences.level = 'Advanced';
            } 
            else if (question.field === 'domain') {
                conversationState.preferences.domain = option;
            }
            else if (question.field === 'duration') {
                if (option.includes('Less than 2')) conversationState.preferences.duration = '2 weeks';
                else if (option.includes('2-5')) conversationState.preferences.duration = '4 weeks';
                else if (option.includes('5-10')) conversationState.preferences.duration = '6 weeks';
                else if (option.includes('More than 10')) conversationState.preferences.duration = '8 weeks';
            }

            // Show next question after delay
            setTimeout(() => {
                showQuizQuestion(questionIndex + 1);
            }, 800);
        }

        // Domain selection
        function askAboutDomain() {
            const domains = [...new Set(courses.map(course => course.domain))];
            let buttonsHTML = domains.map(domain => 
                `<button class="btn" onclick="selectOption('${domain}')">${domain}</button>`
            ).join('');

            const message = `
                <p>What domain are you interested in? You can choose from:</p>
                <div class="btn-group">
                    ${buttonsHTML}
                </div>
                <p class="mt-1"><small>Examples: "I'm interested in web development" or "Data science"</small></p>
            `;
            addMessage(message, 'bot', true);
        }

        function handleDomainSelection(message) {
            const domains = [...new Set(courses.map(course => course.domain))];
            const lowerMsg = message.toLowerCase();
            
            // Try to find a matching domain
            let selectedDomain = null;
            for (const domain of domains) {
                if (lowerMsg.includes(domain.toLowerCase())) {
                    selectedDomain = domain;
                    break;
                }
            }
            
            // Special cases for common synonyms
            if (!selectedDomain) {
                if (lowerMsg.includes('web') || lowerMsg.includes('frontend') || lowerMsg.includes('backend')) {
                    selectedDomain = 'Web Development';
                } else if (lowerMsg.includes('data') || lowerMsg.includes('analysis') || lowerMsg.includes('analytics')) {
                    selectedDomain = 'Data Science';
                } else if (lowerMsg.includes('ai') || lowerMsg.includes('machine learning') || lowerMsg.includes('ml')) {
                    selectedDomain = 'Artificial Intelligence';
                } else if (lowerMsg.includes('mobile') || lowerMsg.includes('app') || lowerMsg.includes('ios') || lowerMsg.includes('android')) {
                    selectedDomain = 'Mobile Development';
                }
            }

            if (selectedDomain) {
                addMessage(`Great! You've selected ${selectedDomain}.`, 'bot');
                conversationState.preferences.domain = selectedDomain;
                conversationState.step = 'level';
                askAboutLevel();
            } else {
                addMessage("I'm not sure I understand which domain you're interested in. Please select one from the list:", 'bot');
                askAboutDomain();
            }
        }

        // Level selection
        function askAboutLevel() {
            const levels = ['Beginner', 'Intermediate', 'Advanced'];
            let buttonsHTML = levels.map(level => 
                `<button class="btn" onclick="selectOption('${level}')">${level}</button>`
            ).join('');

            const message = `
                <p>What's your current skill level?</p>
                <div class="btn-group">
                    ${buttonsHTML}
                </div>
                <p class="mt-1"><small>Examples: "I'm a beginner" or "I have some experience"</small></p>
            `;
            addMessage(message, 'bot', true);
        }

        function handleLevelSelection(message) {
            const detectedLevel = detectLevelFromText(message);
            
            if (detectedLevel) {
                addMessage(`Got it! You're at ${detectedLevel} level.`, 'bot');
                conversationState.preferences.level = detectedLevel;
                conversationState.step = 'duration';
                askAboutDuration();
            } else {
                addMessage("I'm not sure about your skill level. Please select from Beginner, Intermediate, or Advanced.", 'bot');
                askAboutLevel();
            }
        }

        // Duration selection
        function askAboutDuration() {
            const durations = ['2 weeks', '4 weeks', '6 weeks', '8 weeks', '10 weeks', '12 weeks'];
            let buttonsHTML = durations.map(duration => 
                `<button class="btn" onclick="selectOption('${duration}')">${duration}</button>`
            ).join('');

            const message = `
                <p>What duration are you looking for in a course?</p>
                <div class="btn-group">
                    ${buttonsHTML}
                </div>
                <p class="mt-1"><small>Examples: "About a month" or "2-3 months"</small></p>
            `;
            addMessage(message, 'bot', true);
        }

        function handleDurationSelection(message) {
            const lowerMsg = message.toLowerCase();
            let selectedDuration = null;
            
            // Check for specific hour numbers
            const hourMatch = lowerMsg.match(/(\d+)\s*hour/);
            if (hourMatch) {
                const hours = parseInt(hourMatch[1]);
                if (hours <= 2) selectedDuration = '2 weeks';
                else if (hours <= 5) selectedDuration = '4 weeks';
                else if (hours <= 10) selectedDuration = '6 weeks';
                else selectedDuration = '8 weeks';
            }
            
            // Check for specific week numbers
            const weekMatch = lowerMsg.match(/(\d+)\s*week/);
            if (weekMatch && !selectedDuration) {
                const weeks = parseInt(weekMatch[1]);
                if (weeks <= 4) selectedDuration = '4 weeks';
                else if (weeks <= 6) selectedDuration = '6 weeks';
                else if (weeks <= 8) selectedDuration = '8 weeks';
                else if (weeks <= 10) selectedDuration = '10 weeks';
                else selectedDuration = '12 weeks';
            }
            
            // Check for month numbers
            const monthMatch = lowerMsg.match(/(\d+)\s*month/);
            if (monthMatch && !selectedDuration) {
                const months = parseInt(monthMatch[1]);
                if (months <= 1) selectedDuration = '4 weeks';
                else if (months <= 2) selectedDuration = '8 weeks';
                else selectedDuration = '12 weeks';
            }
            
            // Check for duration keywords
            if (!selectedDuration) {
                if (lowerMsg.includes('short') || lowerMsg.includes('quick') || lowerMsg.includes('1 month') || lowerMsg.includes('few weeks')) {
                    selectedDuration = '4 weeks';
                } else if (lowerMsg.includes('medium') || lowerMsg.includes('couple months') || lowerMsg.includes('2 month')) {
                    selectedDuration = '8 weeks';
                } else if (lowerMsg.includes('long') || lowerMsg.includes('extensive') || lowerMsg.includes('3 month') || lowerMsg.includes('semester')) {
                    selectedDuration = '12 weeks';
                }
            }

            if (selectedDuration) {
                addMessage(`I'll look for courses around ${selectedDuration} long.`, 'bot');
                conversationState.preferences.duration = selectedDuration;
                conversationState.step = 'rating';
                askAboutRating();
            } else {
                addMessage("I'm not sure about the duration you prefer. Please select from the options or specify a time frame.", 'bot');
                askAboutDuration();
            }
        }

        // Rating selection
        function askAboutRating() {
            const message = `
                <p>How important is course rating to you? (1-5)</p>
                <div class="rating-scale">
                    <div class="rating-option" onclick="selectRating(1)">1</div>
                    <div class="rating-option" onclick="selectRating(2)">2</div>
                    <div class="rating-option" onclick="selectRating(3)">3</div>
                    <div class="rating-option" onclick="selectRating(4)">4</div>
                    <div class="rating-option" onclick="selectRating(5)">5</div>
                </div>
                <p class="mt-1"><small>1 = Not important, 5 = Very important</small></p>
                <p class="mt-1"><small>You can also type your answer (e.g., "very important" or "3")</small></p>
            `;
            addMessage(message, 'bot', true);
        }

        function selectRating(rating) {
            // Highlight selected rating
            const ratingOptions = document.querySelectorAll('.rating-option');
            ratingOptions.forEach((opt, idx) => {
                if (idx + 1 === rating) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });

            conversationState.preferences.rating = rating;
            
            // Move to next step after delay
            setTimeout(() => {
                conversationState.step = 'keywords';
                askAboutKeywords();
            }, 800);
        }

        function handleRatingSelection(message) {
            const lowerMsg = message.toLowerCase();
            let rating = null;
            
            // Check for explicit numbers
            const numMatch = lowerMsg.match(/\d+/);
            if (numMatch) {
                rating = parseInt(numMatch[0]);
                if (rating >= 1 && rating <= 5) {
                    selectRating(rating);
                    return;
                }
            }
            
            // Check for text descriptions
            if (lowerMsg.includes('not important') || lowerMsg.includes('doesn\'t matter') || lowerMsg.includes('any rating')) {
                rating = 1;
            } else if (lowerMsg.includes('somewhat important') || lowerMsg.includes('kind of important')) {
                rating = 3;
            } else if (lowerMsg.includes('very important') || lowerMsg.includes('extremely important') || lowerMsg.includes('high rating')) {
                rating = 5;
            } else if (lowerMsg.includes('important')) {
                rating = 4;
            }
            
            if (rating) {
                selectRating(rating);
            } else {
                addMessage("I'm not sure how important course ratings are to you. Please select a number between 1 and 5.", 'bot');
                askAboutRating();
            }
        }

        // Keywords selection
        function askAboutKeywords() {
            // Get all unique keywords from courses
            const allKeywords = [];
            courses.forEach(course => {
                course.keywords.forEach(keyword => {
                    if (!allKeywords.includes(keyword)) {
                        allKeywords.push(keyword);
                    }
                });
            });

            // Show first 10 keywords as buttons (for simplicity)
            const shownKeywords = allKeywords.slice(0, 10);
            let buttonsHTML = shownKeywords.map(keyword => 
                `<button class="btn" onclick="addKeyword('${keyword}')">${keyword}</button>`
            ).join('');

            const message = `
                <p>Any specific topics or technologies you're interested in? (optional)</p>
                <p>You can add multiple keywords:</p>
                <div class="btn-group">
                    ${buttonsHTML}
                </div>
                <div class="mt-1">
                    <button class="btn btn-accent" onclick="finishKeywords()">Done with keywords</button>
                </div>
                <div id="selected-keywords" class="mt-1"></div>
                <p class="mt-1"><small>Examples: "I'm interested in python and react" or "machine learning"</small></p>
            `;
            addMessage(message, 'bot', true);
        }

        function addKeyword(keyword) {
            if (!conversationState.preferences.keywords.includes(keyword)) {
                conversationState.preferences.keywords.push(keyword);
                
                // Update UI to show selected keywords
                const selectedKeywordsDiv = document.getElementById('selected-keywords');
                if (selectedKeywordsDiv) {
                    selectedKeywordsDiv.innerHTML = `
                        <p><strong>Selected keywords:</strong> ${conversationState.preferences.keywords.join(', ')}</p>
                    `;
                }
                scrollToBottom();
            }
        }

        function finishKeywords() {
            conversationState.step = 'recommendations';
            recommendCourses();
        }

        function handleKeywordsSelection(message) {
            // Extract potential keywords from the message
            const lowerMsg = message.toLowerCase();
            const allKeywords = [];
            courses.forEach(course => {
                course.keywords.forEach(keyword => {
                    if (!allKeywords.includes(keyword)) {
                        allKeywords.push(keyword);
                    }
                });
            });
            
            // Find matching keywords
            const matchedKeywords = allKeywords.filter(keyword => 
                lowerMsg.includes(keyword.toLowerCase())
            );
            
            if (matchedKeywords.length > 0) {
                // Add all matched keywords
                matchedKeywords.forEach(keyword => {
                    if (!conversationState.preferences.keywords.includes(keyword)) {
                        conversationState.preferences.keywords.push(keyword);
                    }
                });
                
                // Show confirmation
                const confirmation = `
                    <p>I've added these keywords: ${matchedKeywords.join(', ')}</p>
                    <p>Current keywords: ${conversationState.preferences.keywords.join(', ')}</p>
                    <p>Would you like to add more keywords?</p>
                    <div class="btn-group">
                        <button class="btn" onclick="selectOption('Yes')">Yes</button>
                        <button class="btn btn-accent" onclick="finishKeywords()">No, recommend courses</button>
                    </div>
                `;
                addMessage(confirmation, 'bot', true);
            } else {
                // No keywords found
                const noKeywords = `
                    <p>I didn't recognize any specific keywords in your message. Would you like to:</p>
                    <div class="btn-group">
                        <button class="btn" onclick="selectOption('Try again')">Try entering different keywords</button>
                        <button class="btn btn-accent" onclick="finishKeywords()">Skip keywords and recommend courses</button>
                    </div>
                `;
                addMessage(noKeywords, 'bot', true);
            }
        }
        function explainRecommendationStrategy() {
    const explanation = `
        <p>I found these courses by:</p>
        <ul>
            <li>Prioritizing ${conversationState.preferences.domain || 'all domains'}</li>
            <li>Including ${conversationState.preferences.level ? conversationState.preferences.level.toLowerCase() : 'all'} level courses</li>
            <li>Focusing on ${conversationState.preferences.duration || 'various'} durations</li>
            ${conversationState.preferences.keywords.length > 0 ? 
                `<li>Matching your keywords: ${conversationState.preferences.keywords.join(', ')}</li>` : ''}
        </ul>
    `;
    addMessage(explanation, 'bot', true);
}

        // Course recommendation
        // Enhanced course recommendation algorithm
function recommendCourses() {
    showTypingIndicator();
    
    setTimeout(() => {
        hideTypingIndicator();
        
        // Start with all courses
        let recommended = [...courses];
        let fallbackCourses = [];
        
        // Domain filter (always apply)
        if (conversationState.preferences.domain) {
            recommended = recommended.filter(course => 
                course.domain === conversationState.preferences.domain
            );
            // Prepare domain fallback (top rated in domain)
            fallbackCourses = courses.filter(c => 
                c.domain === conversationState.preferences.domain
            ).sort((a, b) => b.rating - a.rating);
        }
        
        // Level filter (with flexibility)
        if (conversationState.preferences.level) {
            const levelMap = {
                'Beginner': ['Beginner'],
                'Intermediate': ['Intermediate', 'Beginner'],
                'Advanced': ['Advanced', 'Intermediate']
            };
            const allowedLevels = levelMap[conversationState.preferences.level] || [];
            recommended = recommended.filter(course => 
                allowedLevels.includes(course.level)
            );
        }
        
        // Duration filter (with range flexibility)
        if (conversationState.preferences.duration) {
            const prefDuration = parseInt(conversationState.preferences.duration);
            const durationRange = {
                min: Math.max(1, prefDuration - 2),
                max: prefDuration + 4
            };
            recommended = recommended.filter(course => {
                const courseDuration = parseInt(course.duration);
                return courseDuration >= durationRange.min && 
                       courseDuration <= durationRange.max;
            });
        }
        
        // Rating filter (with flexibility)
        if (conversationState.preferences.rating) {
            const minRating = Math.max(3.5, 
                conversationState.preferences.rating >= 4 ? 4.0 : 
                conversationState.preferences.rating >= 3 ? 3.5 : 3.0
            );
            recommended = recommended.filter(course => course.rating >= minRating);
        }
        
        // Keywords filter (optional)
        if (conversationState.preferences.keywords.length > 0) {
            const keywordMatches = recommended.map(course => {
                const matchCount = course.keywords.filter(keyword => 
                    conversationState.preferences.keywords.includes(keyword)
                ).length;
                return { course, matchCount };
            }).filter(item => item.matchCount > 0);
            
            if (keywordMatches.length > 0) {
                // Sort by number of keyword matches
                recommended = keywordMatches
                    .sort((a, b) => b.matchCount - a.matchCount)
                    .map(item => item.course);
            }
        }
        
        // If no courses match, implement fallback strategy
        if (recommended.length === 0) {
            // First fallback: Relax level and duration constraints
            recommended = [...courses];
            if (conversationState.preferences.domain) {
                recommended = recommended.filter(course => 
                    course.domain === conversationState.preferences.domain
                );
            }
            
            // Second fallback: Use top-rated courses in domain
            if (recommended.length === 0 && fallbackCourses.length > 0) {
                recommended = fallbackCourses.slice(0, 5);
            }
            
            // Final fallback: Show top-rated courses overall
            if (recommended.length === 0) {
                recommended = courses
                    .sort((a, b) => b.rating - a.rating)
                    .slice(0, 5);
            }
        }
        
        // Limit to 5 courses and save
        recommended = recommended.slice(0, 5);
        conversationState.recommendedCourses = recommended;
        
        // Show recommendations or error message
        if (recommended.length > 0) {
            showRecommendations(recommended);
            
            // Explain if we used fallback strategy
            if (recommended.some(c => !conversationState.preferences.domain || 
                c.domain !== conversationState.preferences.domain)) {
                addMessage("I've expanded the search to find relevant courses for you.", 'bot');
            }
        } else {
            addMessage("I couldn't find any courses matching your criteria. Let's try adjusting your preferences.", 'bot');
            conversationState.step = 'welcome';
            setTimeout(showWelcomeMessage, 1000);
        }
        
        saveConversationState();
    }, 1500);
}

        // Show course recommendations
        function showRecommendations(courses) {
    let coursesHTML = courses.map(course => `
        <div class="course-card">
            <div class="course-title">
                <a href="${course.url}" target="_blank">${course.name}</a>
            </div>
            <div class="course-meta">
                <span>${course.domain}</span>
                <span>${course.level}</span>
                <span>${course.duration}</span>
                <span class="course-rating">★ ${course.rating}</span>
                <span>${course.platform}</span>
            </div>
            <p>${course.description}</p>
            <div class="course-actions">
                <button class="btn" onclick="showSimilarCourses(${course.id})">Show Similar</button>
                <button class="btn btn-accent" onclick="window.open('${course.url}', '_blank')">Visit Course</button>
            </div>
        </div>
    `).join('');
    
    const messageHTML = `
        <p>Here are some courses that match your preferences:</p>
        ${coursesHTML}
        <div class="mt-2">
            <p>Would you like to:</p>
            <div class="btn-group">
                <button class="btn" onclick="selectOption('Start over')">Start over</button>
                <button class="btn" onclick="selectOption('Adjust preferences')">Adjust preferences</button>
            </div>
        </div>
    `;
    
    addMessage(messageHTML, 'bot', true);
}

        // Show similar courses
        function showSimilarCourses(courseId) {
    const originalCourse = courses.find(c => c.id === courseId);
    if (!originalCourse) return;
    
    const similarCourses = courses.filter(course => {
        if (course.id === courseId) return false;
        
        const matchingKeywords = course.keywords.filter(keyword => 
            originalCourse.keywords.includes(keyword)
        );
        
        return matchingKeywords.length >= 2;
    }).slice(0, 3);
    
    if (similarCourses.length > 0) {
        let coursesHTML = similarCourses.map(course => `
            <div class="course-card">
                <div class="course-title">
                    <a href="${course.url}" target="_blank">${course.name}</a>
                </div>
                <div class="course-meta">
                    <span>${course.domain}</span>
                    <span>${course.level}</span>
                    <span>${course.duration}</span>
                    <span class="course-rating">★ ${course.rating}</span>
                    <span>${course.platform}</span>
                </div>
                <p>${course.description}</p>
                <div class="course-actions">
                    <button class="btn btn-accent" onclick="window.open('${course.url}', '_blank')">Visit Course</button>
                </div>
            </div>
        `).join('');
        
        const messageHTML = `
            <p>Here are some courses similar to "<a href="${originalCourse.url}" target="_blank">${originalCourse.name}</a>":</p>
            ${coursesHTML}
        `;
        
        addMessage(messageHTML, 'bot', true);
    } else {
        addMessage(`I couldn't find any courses similar to "${originalCourse.name}".`, 'bot');
    }
}

        // Handle recommendation response
        function handleRecommendationResponse(message) {
            const lowerMsg = message.toLowerCase();
            
            if (lowerMsg.includes('start over') || lowerMsg.includes('reset') || lowerMsg.includes('begin again')) {
                // Reset conversation
                conversationState = {
                    step: 'welcome',
                    preferences: {
                        domain: null,
                        level: null,
                        duration: null,
                        rating: null,
                        keywords: []
                    },
                    quizAnswers: [],
                    recommendedCourses: []
                };
                saveConversationState();
                showWelcomeMessage();
            } else if (lowerMsg.includes('adjust') || lowerMsg.includes('preference') || lowerMsg.includes('change')) {
                // Determine which preference to adjust based on message
                if (lowerMsg.includes('domain') || lowerMsg.includes('subject') || lowerMsg.includes('topic')) {
                    conversationState.step = 'domain';
                    askAboutDomain();
                } else if (lowerMsg.includes('level') || lowerMsg.includes('skill') || lowerMsg.includes('experience')) {
                    conversationState.step = 'level';
                    askAboutLevel();
                } else if (lowerMsg.includes('duration') || lowerMsg.includes('length') || lowerMsg.includes('time')) {
                    conversationState.step = 'duration';
                    askAboutDuration();
                } else if (lowerMsg.includes('rating') || lowerMsg.includes('quality') || lowerMsg.includes('review')) {
                    conversationState.step = 'rating';
                    askAboutRating();
                } else if (lowerMsg.includes('keyword') || lowerMsg.includes('topic') || lowerMsg.includes('specific')) {
                    conversationState.step = 'keywords';
                    askAboutKeywords();
                } else {
                    // General preference adjustment
                    const adjustMessage = `
                        <p>Which preference would you like to adjust?</p>
                        <div class="btn-group">
                            <button class="btn" onclick="selectOption('Domain')">Domain</button>
                            <button class="btn" onclick="selectOption('Skill level')">Skill level</button>
                            <button class="btn" onclick="selectOption('Duration')">Duration</button>
                            <button class="btn" onclick="selectOption('Rating importance')">Rating importance</button>
                            <button class="btn" onclick="selectOption('Keywords')">Keywords</button>
                        </div>
                    `;
                    addMessage(adjustMessage, 'bot', true);
                }
            } else {
                // Unrecognized response
                const optionsMessage = `
                    <p>Would you like to start over or adjust your preferences?</p>
                    <div class="btn-group">
                        <button class="btn" onclick="selectOption('Start over')">Start over</button>
                        <button class="btn" onclick="selectOption('Adjust preferences')">Adjust preferences</button>
                    </div>
                `;
                addMessage(optionsMessage, 'bot', true);
            }
        }

        // Handle default response
        function handleDefaultResponse(message) {
            // Try to understand the intent
            const lowerMsg = message.toLowerCase();
            
            if (lowerMsg.includes('hello') || lowerMsg.includes('hi') || lowerMsg.includes('hey')) {
                addMessage("Hello again! How can I help you with course recommendations?", 'bot');
            } else if (lowerMsg.includes('thank') || lowerMsg.includes('thanks')) {
                addMessage("You're welcome! Is there anything else I can help you with?", 'bot');
            } else if (lowerMsg.includes('help') || lowerMsg.includes('support')) {
                addMessage("I can help you find courses based on your preferences. Would you like to start with a skill assessment or set preferences directly?", 'bot');
            } else {
                addMessage("I'm not sure how to respond to that. Please select one of the options provided or ask about course recommendations.", 'bot');
            }
            
            renderBasedOnState();
        }

        // Helper function to select options via buttons
        function selectOption(option) {
            // Simulate user selecting the option
            addMessage(option, 'user');
            showTypingIndicator();
            
            // Process after a short delay
            setTimeout(() => {
                hideTypingIndicator();
                processUserMessage(option);
            }, 500);
        }

        // Render based on current state
        function renderBasedOnState() {
            switch (conversationState.step) {
                case 'welcome':
                    showWelcomeMessage();
                    break;
                case 'domain':
                    askAboutDomain();
                    break;
                case 'level':
                    askAboutLevel();
                    break;
                case 'duration':
                    askAboutDuration();
                    break;
                case 'rating':
                    askAboutRating();
                    break;
                case 'keywords':
                    askAboutKeywords();
                    break;
                case 'quiz':
                    const currentQuestionIndex = conversationState.quizAnswers.length;
                    if (currentQuestionIndex < quizQuestions.length) {
                        showQuizQuestion(currentQuestionIndex);
                    } else {
                        conversationState.step = 'recommendations';
                        recommendCourses();
                    }
                    break;
                case 'recommendations':
                    if (conversationState.recommendedCourses.length > 0) {
                        showRecommendations(conversationState.recommendedCourses);
                    } else {
                        recommendCourses();
                    }
                    break;
            }
        }

        // Save conversation state to session storage
        function saveConversationState() {
            sessionStorage.setItem('eduBotState', JSON.stringify(conversationState));
        }

        // Export recommendations as PDF
        function exportRecommendations() {
            if (conversationState.recommendedCourses.length === 0) {
                addMessage("No recommendations to export yet. Please complete the conversation first.", 'bot');
                return;
            }

            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                // Create a new PDF document
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add title
                doc.setFontSize(22);
                doc.setTextColor(40, 53, 147);
                doc.text('Your Personalized Course Recommendations', 105, 20, { align: 'center' });
                
                // Add subtitle with date
                doc.setFontSize(12);
                doc.setTextColor(100);
                doc.text(`Generated on ${new Date().toLocaleDateString()} by EduBot`, 105, 28, { align: 'center' });
                
                // Add user preferences section
                doc.setFontSize(16);
                doc.setTextColor(40, 53, 147);
                doc.text('Your Preferences', 20, 40);
                
                doc.setFontSize(12);
                doc.setTextColor(0);
                let yPosition = 50;
                
                if (conversationState.preferences.domain) {
                    doc.text(`• Domain: ${conversationState.preferences.domain}`, 20, yPosition);
                    yPosition += 7;
                }
                
                if (conversationState.preferences.level) {
                    doc.text(`• Skill Level: ${conversationState.preferences.level}`, 20, yPosition);
                    yPosition += 7;
                }
                
                if (conversationState.preferences.duration) {
                    doc.text(`• Duration: ${conversationState.preferences.duration}`, 20, yPosition);
                    yPosition += 7;
                }
                
                if (conversationState.preferences.rating) {
                    doc.text(`• Minimum Rating: ${'★'.repeat(conversationState.preferences.rating)}`, 20, yPosition);
                    yPosition += 7;
                }
                
                if (conversationState.preferences.keywords.length > 0) {
                    doc.text(`• Keywords: ${conversationState.preferences.keywords.join(', ')}`, 20, yPosition);
                    yPosition += 10;
                } else {
                    yPosition += 3;
                }
                
                // Add recommended courses section
                doc.setFontSize(16);
                doc.setTextColor(40, 53, 147);
                doc.text('Recommended Courses', 20, yPosition);
                yPosition += 10;
                
                doc.setFontSize(12);
                doc.setTextColor(0);
                
                // Add each recommended course
                conversationState.recommendedCourses.forEach((course, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(30, 30, 30);
                    doc.text(`${index + 1}. ${course.name}`, 20, yPosition);
                    yPosition += 8;
                    
                    doc.setFontSize(10);
                    doc.setTextColor(100);
                    
                    // Course metadata
                    let meta = [];
                    if (course.platform) meta.push(`Platform: ${course.platform}`);
                    if (course.level) meta.push(`Level: ${course.level}`);
                    if (course.duration) meta.push(`Duration: ${course.duration}`);
                    if (course.rating) meta.push(`Rating: ${'★'.repeat(Math.round(course.rating))}`);
                    
                    doc.text(meta.join(' | '), 20, yPosition);
                    yPosition += 6;
                    
                    // Course description
                    doc.setFontSize(11);
                    doc.setTextColor(50);
                    const splitDescription = doc.splitTextToSize(course.description, 170);
                    doc.text(splitDescription, 20, yPosition);
                    yPosition += splitDescription.length * 6 + 5;
                    
                    // Course URL
                    doc.setFontSize(10);
                    doc.setTextColor(30, 100, 200);
                    doc.textWithLink('Course Link →', 20, yPosition, { url: course.url });
                    yPosition += 10;
                    
                    // Add separator
                    doc.setDrawColor(200);
                    doc.line(20, yPosition, 190, yPosition);
                    yPosition += 10;
                });
                
                // Save the PDF
                doc.save('EduBot_Course_Recommendations.pdf');
                
                addMessage("Your recommendations have been exported as a PDF file!", 'bot');
            }, 1000);
        }

        // Initialize particles.js
        function initParticles() {
            // Inline configuration for particles.js
            const particlesConfig = {
                "particles": {
                    "number": {
                        "value": 80,
                        "density": {
                            "enable": true,
                            "value_area": 800
                        }
                    },
                    "color": {
                        "value": "#ffffff"
                    },
                    "shape": {
                        "type": "circle",
                        "stroke": {
                            "width": 0,
                            "color": "#000000"
                        },
                        "polygon": {
                            "nb_sides": 5
                        }
                    },
                    "opacity": {
                        "value": 0.5,
                        "random": false,
                        "anim": {
                            "enable": false,
                            "speed": 1,
                            "opacity_min": 0.1,
                            "sync": false
                        }
                    },
                    "size": {
                        "value": 3,
                        "random": true,
                        "anim": {
                            "enable": false,
                            "speed": 40,
                            "size_min": 0.1,
                            "sync": false
                        }
                    },
                    "line_linked": {
                        "enable": true,
                        "distance": 150,
                        "color": "#ffffff",
                        "opacity": 0.4,
                        "width": 1
                    },
                    "move": {
                        "enable": true,
                        "speed": 2,
                        "direction": "none",
                        "random": false,
                        "straight": false,
                        "out_mode": "out",
                        "bounce": false,
                        "attract": {
                            "enable": false,
                            "rotateX": 600,
                            "rotateY": 1200
                        }
                    }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                        "onhover": {
                            "enable": true,
                            "mode": "grab"
                        },
                        "onclick": {
                            "enable": true,
                            "mode": "push"
                        },
                        "resize": true
                    },
                    "modes": {
                        "grab": {
                            "distance": 140,
                            "line_linked": {
                                "opacity": 1
                            }
                        },
                        "bubble": {
                            "distance": 400,
                            "size": 40,
                            "duration": 2,
                            "opacity": 8,
                            "speed": 3
                        },
                        "repulse": {
                            "distance": 200,
                            "duration": 0.4
                        },
                        "push": {
                            "particles_nb": 4
                        },
                        "remove": {
                            "particles_nb": 2
                        }
                    }
                },
                "retina_detect": true
            };

            // Load particles.js with our config
            particlesJS('particles-js', particlesConfig);
        }
    </script>
</body>
</html>